<html>
    <head>
	<title>W08: Task 3</title>
    </head>
    <body style="margin:0">
	<script src="three.min.js"></script>
	<script src="TrackballControls.js"></script>
	<script src="https://naohisas.github.io/KVS.js/Build/KVS.min.js"></script>
	<script src="https://naohisas.github.io/KVS.js/Build/KVS2THREE.min.js"></script>
	<script src="https://naohisas.github.io/KVS.js/Source/KVSLobsterData.js"></script>
    <script src="Bounds.js"></script>
	<script src="Isosurfaces.js"></script>
    <script src="Lut.js"></script>
    <script src="main.js"></script>
    
    <script type="x-shader/x-vertex" id="phong.vert">
        varying vec3 point_color;
        varying vec4 point_position;
        varying vec3 normal_vector;
        varying vec3 light_position;

        void main()
        {
            point_color = color;
            point_position = modelViewMatrix * vec4(position, 1.0);
            normal_vector = normalMatrix * normal;
            gl_Position = projectionMatrix * point_position;
        }
	</script>

    <P>cook_torrance</P>
    <script type="x-shader/x-fragment" id="phong.frag">
        varying vec3 point_color;
        varying vec3 normal_vector;
        varying vec3 light_position;
        varying vec4 point_position;
        

        vec3 PhongReflection(vec3 C, vec3 L, vec3 N){
            float ka = 0.3;
            float kd = 0.5;
            float ks = 0.8;
            float n = 50.0;

            vec3 R = reflect(-L, N);
            vec3 V = normalize(cameraPosition - point_position.xyz);
            float dd = max(dot(N, L), 0.0);
            float ds = pow(max(dot(R, V), 0.0), n);
            if(dd <= 0.0){
                ds = 0.0;
            }
            float Ia = ka;
            float Id = kd * dd;
            float Is = ks * ds;
            return C * (Ia + Id + Is);
        }

        void main()
        {
            vec3 C = point_color;
            vec3 L = normalize(light_position - point_position.xyz);
            vec3 N = normalize(normal_vector);
            vec3 shaded_color = PhongReflection(C, L, N);
            gl_FragColor = vec4( shaded_color, 1.0 );
        }
    </script>
    <script type="x-shader/x-vertex" id="cook_torrance.vert">
        varying vec3 point_color;
        varying vec4 point_position;
        varying vec3 normal_vector;
        varying vec3 light_position;

        void main()
        {
            point_color = color;
            point_position = modelViewMatrix * vec4(position, 1.0);
            normal_vector = normalMatrix * normal;
            gl_Position = projectionMatrix * point_position;
        }
	</script>

    <script type="x-shader/x-fragment" id="cook_torrance.frag">
        varying vec3 point_color;
        varying vec3 normal_vector;
        varying vec3 light_position;
        varying vec4 point_position;


        vec3 CookTorranceReflection(vec3 C, vec3 L, vec3 N){
            float ka = 0.3;
            float kd = 0.5;
            float ks = 0.8;
            float n = 50.0;

            vec3 V = normalize(cameraPosition - point_position.xyz);
            vec3 H = normalize(L + V);
            float NH = dot(N,H);
            float VH = dot(V,H);
            float NV = dot(N,V);
            float NL = dot(N,L);

            float m = 0.1;
            float D = (1.0/(4.0*m*m*NH*NH*NH*NH))*exp((NH*NH-1.0)/(m*m*NH*NH));
            float G = min(1.0, min((2.0*NH*NV)/VH, (2.0*NH*NL)/VH));
            float c = VH;
            float refrac = 2.0;
            float g = sqrt(refrac*refrac+c*c-1.0);
            float F = ((g-c)*(g-c)/((g+c)*(g+c)))*(1.0+(c*(g+c)-1.0)*(c*(g+c)-1.0)/((c*(g-c)-1.0)*(c*(g-c)-1.0)));

            float dd = max(dot(N, L), 0.0);
            float ds = D*G*F/NV;
            if(dd <= 0.0){
                ds = 0.0;
            }
            float Ia = ka;
            float Id = kd * dd;
            float Is = ks * ds;
            return C * (Ia + Id + Is);
        }

        void main()
        {
            vec3 C = point_color;
            vec3 L = normalize(light_position - point_position.xyz);
            vec3 N = normalize(normal_vector);
            vec3 shaded_color = CookTorranceReflection(C, L, N);
            gl_FragColor = vec4( shaded_color, 1.0 );
        }
    </script>

	<script>
	 task3();
	</script>
    </body>
</html>
